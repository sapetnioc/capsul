
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  
    <title>CAPSUL &#8212; CAPSUL - Chain algorithm in pipelines and execute in many contexts</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../_static/css/bootstrap-responsive.css"/>
  <link rel="icon" href="../../_static/capsul_logo.svg"/>

    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <!-- sidebar -->
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../_static/js/bootstrap.min.js" type="application/javascript"></script>

  <script type="application/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  <div class="header" style="display: inline; width: 80%; margin-left:10%;">
    <a href="../../index.html">
    <img src="../../_static/capsul_logo.svg" alt="Capsul logo" style="display: inline; height:4em;"/>
    </a >
    <div class="navbar" style="display: inline;">
      <ul>
        <li><a href="../../index.html">Home</a></li>
        <li><a href="../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
            <a href="../../documentation.html">Documentation</a>
            <a class="btn dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="link-title">CAPSUL</li>
              <li><a href="../../user_guide_tree/index.html">User guide</a></li>
              <li><a href="../../api/index.html">API</a></li>
            </ul>
          </div>
        </li>
        <li>
          <!-- form action="search.html" method="get" style="display: inline-block;"></form>
            <input type="text" class="search-header" name="q" placeholder="search documentation..." value=""></input>
            <button type="submit" >search</button>
          </form -->
          <form class="search_box" method="get" action="http://www.google.com/search" style="display: inline-block;">
            <input class="search-header" type="text" name="q" placeholder="search documentation..." />
            <input class="submit" type="image" src="../../_static/find_read.png" value="Search" />
            <input type="hidden" name="sitesearch" value="brainvisa.info/capsul" />
          </form>
        </li>
      </ul>
    </div> <!-- end navbar -->
  </div>


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for capsul.engine</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module defines the main API to interact with Capsul processes.</span>
<span class="sd">In order to execute a process, it is mandatory to have an instance of</span>
<span class="sd">:py:class:`CapsulEngine`. Such an instance can be created with factory</span>
<span class="sd">:py:func:`capsul_engine`</span>

<span class="sd">Classes</span>
<span class="sd">=======</span>
<span class="sd">:class:`CapsulEngine`</span>
<span class="sd">---------------------</span>

<span class="sd">Functions</span>
<span class="sd">=========</span>
<span class="sd">:func:`database_factory`</span>
<span class="sd">------------------------</span>
<span class="sd">:func:`capsul_engine`</span>
<span class="sd">---------------------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">traits.api</span> <span class="k">import</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Undefined</span>

<span class="kn">from</span> <span class="nn">soma.controller</span> <span class="k">import</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">controller_to_dict</span>
<span class="kn">from</span> <span class="nn">soma.serialization</span> <span class="k">import</span> <span class="n">to_json</span><span class="p">,</span> <span class="n">from_json</span>
<span class="kn">from</span> <span class="nn">soma.sorted_dictionary</span> <span class="k">import</span> <span class="n">SortedDictionary</span>

<span class="kn">from</span> <span class="nn">.database_json</span> <span class="k">import</span> <span class="n">JSONDBEngine</span>
<span class="kn">from</span> <span class="nn">.database_populse</span> <span class="k">import</span> <span class="n">PopulseDBEngine</span>

<span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">.module</span> <span class="k">import</span> <span class="n">default_modules</span>

<div class="viewcode-block" id="CapsulEngine"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine">[docs]</a><span class="k">class</span> <span class="nc">CapsulEngine</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A CapsulEngine is the mandatory entry point of all software using Capsul. It contains objects to store configuration and metadata, define execution environment(s) (possibly remote) and perform pipelines execution.</span>
<span class="sd">    </span>
<span class="sd">    A CapsulEngine must be created using capsul.engine.capsul_engine function. For instance::</span>
<span class="sd">    </span>
<span class="sd">        from capsul.engine import capsul_engine</span>
<span class="sd">        ce = capsul_engine()</span>

<span class="sd">    Or::</span>

<span class="sd">        from capsul.api import capsul_engine</span>
<span class="sd">        ce = capsul_engine()</span>

<span class="sd">    By default, CapsulEngine only store necessary configuration. But it may be necessary to modify Python environment globally to apply this configuration. For instance, Nipype must be configured globally. If SPM is configured in CapsulEngine, it is necessary to explicitely activate the configuration in order to modify the global configuration of Nipype for SPM. This activation is done by explicitely activating the execution context of the capsul engine with the following code::</span>
<span class="sd">    </span>
<span class="sd">        from capsul.engine import capsul_engine</span>
<span class="sd">        ce = capsul_engine()</span>
<span class="sd">        # Nipype is not configured here</span>
<span class="sd">        with ce:</span>
<span class="sd">            # Nipype is configured here</span>
<span class="sd">        # Nipype may not be configured here</span>

<span class="sd">    .. note::</span>

<span class="sd">        CapsulEngine is the replacement of the older :class:`~capsul.study_config.study_config.StudyConfig`, which is still present in Capsul 2.2 for backward compatibility, but will disapear in later versions. In Capsul 2.2 both objects exist, and are syn chronized internally, which means that a StudyConfig object wille also ceate a CapsulEngine, and the other way, and modifications in the StudyConfig object will change the corresponding item in CapsulEngine and vice versa. Functionalities of StudyConfig are moving internally to CapsulEngine, StudyConfig being merely a wrapper.</span>

<span class="sd">    **Using CapsulEngine**</span>

<span class="sd">    It is used to store configuration variables, and to handle execution within the configured context. The configuration has 2 independent axes: configuration modules, which provide additional configutation variables, and computing resources.</span>

<span class="sd">    *Computing resources*</span>

<span class="sd">    Capsul is using :somaworkflow:`Soma-Workflow &lt;index.html&gt;` to run processes, and is thus able to connect and execute on a remote computing server. The remote computing resource may have a different configuration from the client one (paths for software or data, available external software etc). So configurations specific to different computing resources should be handled in CapsulEngine. For this, the configuration section is split into several configuration instances, one for each computing resource.</span>

<span class="sd">    As this is a little bit complex to handle at first, a &quot;global&quot; configuraiton is used to maintain all common configuration options. It is typically used to work on the local machine, especially for users who only work locally. This configuration object is found under the ``global_config`` object in a CapsulEngine instance. It is a :class:`~soma.controller.controller.Controller` object::</span>

<span class="sd">        &gt;&gt;&gt; from capsul.api import capsul_engine</span>
<span class="sd">        &gt;&gt;&gt; ce = capsul_engine()</span>
<span class="sd">        &gt;&gt;&gt; config = ce.global_config</span>
<span class="sd">        &gt;&gt;&gt; print(config.export_to_dict())</span>
<span class="sd">        OrderedDict([(&#39;fsl&#39;, OrderedDict([(&#39;config&#39;, &lt;undefined&gt;), (&#39;directory&#39;, &lt;undefined&gt;), (&#39;prefix&#39;, &lt;undefined&gt;), (&#39;use&#39;, &lt;undefined&gt;)])), (&#39;matlab&#39;, OrderedDict([(&#39;executable&#39;, &lt;undefined&gt;)])), (&#39;spm&#39;, OrderedDict([(&#39;directory&#39;, &lt;undefined&gt;), (&#39;standalone&#39;, &lt;undefined&gt;), (&#39;use&#39;, &lt;undefined&gt;), (&#39;version&#39;, &lt;undefined&gt;)])), (&#39;axon&#39;, OrderedDict([(&#39;shared_directory&#39;, &lt;undefined&gt;)])), (&#39;attributes&#39;, OrderedDict([(&#39;attributes_schema_paths&#39;, [u&#39;capsul.attributes.completion_engine_factory&#39;]), (&#39;attributes_schemas&#39;, OrderedDict()), (&#39;path_completion&#39;, &lt;undefined&gt;), (&#39;process_completion&#39;, &#39;builtin&#39;)]))])</span>

<span class="sd">    Whenever a new computing resource is used, it can be added as a new configuration using :meth:`add_computing_resource`. Configuration options for this resource are a merge of the global one, and the specific ones::</span>

<span class="sd">        &gt;&gt;&gt; ce.add_computing_resource(&#39;computing_server&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ce.global_config.spm.directory = &#39;/tmp&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(ce.config(&#39;spm.directory&#39;, &#39;computing_server&#39;)</span>
<span class="sd">        &#39;/tmp&#39;</span>
<span class="sd">        &gt;&gt;&gt; ce.set_config(&#39;spm.directory&#39;, &#39;/home/myself&#39;, &#39;computing_server&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(ce.config(&#39;spm.directory&#39;, &#39;computing_server&#39;)</span>
<span class="sd">        &#39;/home/myself&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(ce.config(&#39;spm.directory&#39;)</span>
<span class="sd">        &#39;/tmp&#39;</span>

<span class="sd">    *configuration modules*</span>

<span class="sd">    The configuration is handled through a set of configuration modules. Each is dedicated for a topic (for instance handling a specific external software paths, or managing process parameters completion,; etc). A module adds a configuration Controller, with its own variables, and is able to manage runtime configuration of programs, if needed, through environment variables. Capsul comes with a set of prefedined modules:</span>
<span class="sd">    :class:`~capsul.engine.module.attributes.AttributesConfig`,</span>
<span class="sd">    :class:`~capsul.engine.module.axon.AxonConfig`,</span>
<span class="sd">    :class:`~capsul.engine.module.fom.FomConfig`,</span>
<span class="sd">    :class:`~capsul.engine.module.fsl.FSLConfig`,</span>
<span class="sd">    :class:`~capsul.engine.module.matlab.MatlabConfig`,</span>
<span class="sd">    :class:`~capsul.engine.module.spm.SPMConfig`</span>

<span class="sd">    **Methods**</span>
<span class="sd">    &#39;&#39;&#39;</span>
            
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">database_location</span><span class="p">,</span>
                 <span class="n">database</span><span class="p">,</span>
                 <span class="n">require</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        CapsulEngine.__init__(self, database_location, database, config=None)</span>

<span class="sd">        The CapsulEngine constructor should not be called directly.</span>
<span class="sd">        Use :func:`capsul_engine` factory function instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CapsulEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_database_location</span> <span class="o">=</span> <span class="n">database_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_modules</span><span class="p">(</span><span class="n">require</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_engine</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">json_value</span><span class="p">(</span><span class="s1">&#39;metadata_engine&#39;</span><span class="p">))</span>
        

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_location</span>
        
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_engine</span>
    
    <span class="nd">@metadata_engine</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">metadata_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_engine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_engine</span> <span class="o">=</span> <span class="n">metadata_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_json_value</span><span class="p">(</span><span class="s1">&#39;metadata_engine&#39;</span><span class="p">,</span> 
                                     <span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_engine</span><span class="p">))</span>
    
<div class="viewcode-block" id="CapsulEngine.load_modules"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.load_modules">[docs]</a>    <span class="k">def</span> <span class="nf">load_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">require</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Call self.load_module for each required module. The list of modules</span>
<span class="sd">        to load is located in self.modules (if it is None,</span>
<span class="sd">        capsul.module.default_modules is used).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">require</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">require</span> <span class="o">=</span> <span class="n">default_modules</span>
        
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">require</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span></div>

<div class="viewcode-block" id="CapsulEngine.load_module"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.load_module">[docs]</a>    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a module if it has not already been loaded (is this case,</span>
<span class="sd">        nothing is done)</span>
<span class="sd">        </span>
<span class="sd">        A module is a fully qualified name of a Python module (as accepted</span>
<span class="sd">        by Python import statement). Such a module must define the two</span>
<span class="sd">        following functions (and may define two others, see below):</span>
<span class="sd">        </span>
<span class="sd">        def load_module(capsul_engine, module_name):        </span>
<span class="sd">        def set_environ(config, environ):</span>
<span class="sd">        </span>
<span class="sd">        load_module of each module is called once before reading and applying</span>
<span class="sd">        the configuration. It can be used to add traits to the CapsulEngine</span>
<span class="sd">        in order to define the configuration options that are used by the</span>
<span class="sd">        module. Values of these traits are automatically stored in</span>
<span class="sd">        configuration in database when self.save() is used, and they are</span>
<span class="sd">        retrieved from database before initializing modules.</span>
<span class="sd">        </span>
<span class="sd">        set__environ is called in the context of the processing (i.e. on </span>
<span class="sd">        he, possibly remote, machine that runs the pipelines). It receives</span>
<span class="sd">        the configuration as a JSON compatible dictionary (for instance a</span>
<span class="sd">        CapsulEngine attibute `capsul_engine.spm.directory` would be</span>
<span class="sd">        config[&#39;spm&#39;][&#39;directory&#39;]). The function must modify the environ</span>
<span class="sd">        dictionary to set the environment variables that must be defined</span>
<span class="sd">        for pipeline configuration. These variables are typically used by</span>
<span class="sd">        modules in capsul.in_context module to manage running external</span>
<span class="sd">        software with appropriate configuration. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="n">python_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="n">init_settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">python_module</span><span class="p">,</span> <span class="s1">&#39;init_settings&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">init_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">init_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>
    
        
    <span class="c1">#</span>
    <span class="c1"># Method imported from self.database</span>
    <span class="c1">#</span>
    
    <span class="c1"># TODO: take computing resource in account in the following methods</span>
    
    <span class="k">def</span> <span class="nf">set_named_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_named_directory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">named_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">named_directory</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">named_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_named_directories</span><span class="p">()</span>
    
    
    <span class="k">def</span> <span class="nf">set_json_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">json_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_json_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">json_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">json_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">json_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">set_path_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">named_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_path_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">named_directory</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">path_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">named_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">set_path_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">named_directory</span><span class="p">)</span>


    <span class="c1">#</span>
    <span class="c1"># Processes and pipelines related methods</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="CapsulEngine.get_process_instance"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.get_process_instance">[docs]</a>    <span class="k">def</span> <span class="nf">get_process_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_or_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The only official way to get a process instance is to use this method.</span>
<span class="sd">        For now, it simply calls self.study_config.get_process_instance</span>
<span class="sd">        but it will change in the future.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">process_or_id</span><span class="p">,</span>
                                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="CapsulEngine.start"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Asynchronously start the exection of a process in the connected </span>
<span class="sd">        computing environment. Returns a string that is an identifier of the</span>
<span class="sd">        process execution and can be used to get the status of the </span>
<span class="sd">        execution or wait for its termination.</span>
<span class="sd">        </span>
<span class="sd">        if history is True, an entry of the process execution is stored in</span>
<span class="sd">        the database. The content of this entry is to be defined but it will</span>
<span class="sd">        contain the process parameters (to restart the process) and will be </span>
<span class="sd">        updated on process termination (for instance to store execution time</span>
<span class="sd">        if possible).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="CapsulEngine.connect"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">computing_resource</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Connect the capsul engine to a computing resource</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="CapsulEngine.connected_to"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.connected_to">[docs]</a>    <span class="k">def</span> <span class="nf">connected_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the name of the computing resource this capsul engine is</span>
<span class="sd">        connected to or None if it is not connected.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="CapsulEngine.disconnect"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Disconnect from a computing ressource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="CapsulEngine.environment_builder"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.environment_builder">[docs]</a>    <span class="k">def</span> <span class="nf">environment_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a string that contains a Python script that must be run in</span>
<span class="sd">        the computing environment in order to define the environment variables</span>
<span class="sd">        that must be given to all processes. The code of this script must be</span>
<span class="sd">        executed in the processing context (i.e. on the, eventualy remote,</span>
<span class="sd">        machine that will run the process). This code is supposed to be executed</span>
<span class="sd">        in a new Python command and prints a JSON dictionary on standard output.</span>
<span class="sd">        This dictionary contain environment variables that must be given to any</span>
<span class="sd">        process using the environment of this capsul engine.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">import_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">(</span><span class="n">exclude_undefined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="n">exclude_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">connected_computing_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected_to</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">connected_computing_resource</span><span class="p">:</span>
            <span class="n">computing_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computing_config</span><span class="p">[</span><span class="n">connected_computing_resource</span><span class="p">]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">computing_config</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">(</span><span class="n">exclude_undefined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">exclude_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from collections import OrderedDict&#39;</span><span class="p">)</span>
        <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;import json&#39;</span><span class="p">)</span>
        <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;import sys&#39;</span><span class="p">)</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;config = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;environ = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_modules</span><span class="p">:</span>
            <span class="n">python_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">python_module</span><span class="p">,</span> <span class="s1">&#39;set_environ&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;import </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span>            
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.set_environ(config, environ)&#39;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;json.dump(environ, sys.stdout)&#39;</span><span class="p">)</span>
        
        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">import_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code</span></div>
    
    
<div class="viewcode-block" id="CapsulEngine.executions"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.executions">[docs]</a>    <span class="k">def</span> <span class="nf">executions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        List the execution identifiers of all processes that have been started</span>
<span class="sd">        but not disposed in the connected computing ressource. Raises an</span>
<span class="sd">        exception if the computing resource is not connected.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
        

<div class="viewcode-block" id="CapsulEngine.dispose"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.dispose">[docs]</a>    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the database with the current state of a process execution and</span>
<span class="sd">        free the resources used in the computing resource (i.e. remove the </span>
<span class="sd">        workflow from SomaWorkflow).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
    
    
<div class="viewcode-block" id="CapsulEngine.interrupt"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.interrupt">[docs]</a>    <span class="k">def</span> <span class="nf">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Try to stop the execution of a process. Does not wait for the process</span>
<span class="sd">        to be terminated.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="CapsulEngine.wait"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wait for the end of a process execution (either normal termination,</span>
<span class="sd">        interruption or error).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="CapsulEngine.status"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a simple value with the status of an execution (queued, </span>
<span class="sd">        running, terminated, error, etc.)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="CapsulEngine.detailed_information"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.detailed_information">[docs]</a>    <span class="k">def</span> <span class="nf">detailed_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return complete (and possibly big) information about a process</span>
<span class="sd">        execution.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">check_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">eid</span><span class="p">)</span>

<div class="viewcode-block" id="CapsulEngine.raise_for_status"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.CapsulEngine.raise_for_status">[docs]</a>    <span class="k">def</span> <span class="nf">raise_for_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">execution_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Raise an exception if a process execution failed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
        

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_builder</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">json_environ</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_environ</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_backup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_environ_backup</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>        
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ_backup</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ_backup</span></div>
        
    
<span class="n">_populsedb_url_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\w+(\+\w+)?://(.*)&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="database_factory"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.database_factory">[docs]</a><span class="k">def</span> <span class="nf">database_factory</span><span class="p">(</span><span class="n">database_location</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a DatabaseEngine from its location string. This location can be</span>
<span class="sd">    either a sqlite file path (ending with &#39;.sqlite&#39; or &#39;:memory:&#39; for an </span>
<span class="sd">    in memory database for testing) or a populse_db URL, or None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">_populsedb_url_re</span> 
    
    <span class="n">engine_directory</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">database_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">database_location</span> <span class="o">=</span> <span class="s1">&#39;:memory:&#39;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">_populsedb_url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">database_location</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">apth</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">engine_directory</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">populse_db</span> <span class="o">=</span> <span class="n">database_location</span>
    <span class="k">elif</span> <span class="n">database_location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">):</span>
        <span class="n">populse_db</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">database_location</span>
        <span class="n">engine_directory</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">database_location</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">database_location</span> <span class="o">==</span> <span class="s1">&#39;:memory:&#39;</span><span class="p">:</span>
        <span class="n">populse_db</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///:memory:&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid database location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">database_location</span><span class="p">)</span>
    
    <span class="n">engine</span> <span class="o">=</span> <span class="n">PopulseDBEngine</span><span class="p">(</span><span class="n">populse_db</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">engine_directory</span><span class="p">:</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">set_named_directory</span><span class="p">(</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">,</span> <span class="n">engine_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">engine</span></div>

<div class="viewcode-block" id="capsul_engine"><a class="viewcode-back" href="../../api/engine.html#capsul.engine.capsul_engine">[docs]</a><span class="k">def</span> <span class="nf">capsul_engine</span><span class="p">(</span><span class="n">database_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    User facrory for creating capsul engines.</span>
<span class="sd">    </span>
<span class="sd">    If no database_location is given, the default value is</span>
<span class="sd">    &#39;~/.config/capsul/capsul_engine.sqlite&#39; where ~ is replaced by the</span>
<span class="sd">    current use home directory (with os.path.expanduser).</span>
<span class="sd">    </span>
<span class="sd">    Configuration is read from a dictionary stored in two database entries.</span>
<span class="sd">    The first entry has the key &#39;global_config&#39; (i.e.</span>
<span class="sd">    database.json_value(&#39;global_config&#39;)), it contains the configuration</span>
<span class="sd">    values that are shared by all processings engines. The secon entry is </span>
<span class="sd">    computing_config`. It contains a dictionary with one item per computing</span>
<span class="sd">    resource where the key is the resource name and the value is configuration </span>
<span class="sd">    values that are specific to this computing resource.</span>
<span class="sd">    </span>
<span class="sd">    Before initialization of the CapsulEngine, modules are loaded. The</span>
<span class="sd">    list of loaded modules is searched in the &#39;modules&#39; value in the</span>
<span class="sd">    database (i.e. in database.json_value(&#39;modules&#39;)) ; if no list is</span>
<span class="sd">    defined in the database, capsul.module.default_modules is used.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#if database_location is None:</span>
        <span class="c1">#database_location = osp.expanduser(&#39;~/.config/capsul/capsul_engine.sqlite&#39;)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">database_factory</span><span class="p">(</span><span class="n">database_location</span><span class="p">)</span>
    <span class="n">capsul_engine</span> <span class="o">=</span> <span class="n">CapsulEngine</span><span class="p">(</span><span class="n">database_location</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="n">require</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">capsul_engine</span></div>
    

<span class="n">configurations</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">activated_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">activate_configuration</span><span class="p">(</span><span class="n">selected_configurations</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">configurations</span>
    
    <span class="n">configurations</span> <span class="o">=</span> <span class="n">selected_configurations</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="n">configurations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="n">activate_module</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">activate_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">activated_modules</span>
    
    <span class="k">if</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">activated_modules</span><span class="p">:</span>
        <span class="n">activated_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">check_configurations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;check_configurations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">complete_configurations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;complete_configurations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_configurations</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">check_configurations</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">complete_configurations</span><span class="p">:</span>
                    <span class="n">complete_configurations</span><span class="p">()</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">check_configurations</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">activate_configurations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;activate_configurations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">activate_configurations</span><span class="p">:</span>
            <span class="n">activate_configurations</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Populse team &lt;support@brainvisa.info&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>